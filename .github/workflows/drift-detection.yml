name: Nightly Drift Detection

on:
  schedule:
    # Runs at 2:00 AM UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch: # Allows you to click "Run Now" to test it

permissions:
  id-token: write # Required for AWS OIDC
  contents: write # Required to create branches
  pull-requests: write # Required to create PRs

jobs:
  detect-drift:
    runs-on: ubuntu-latest
    timeout-minutes: 30 # Cost control cap
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::476114132725:role/github-action-openid # <--- PASTE YOUR ARN HERE
          aws-region: us-east-1 # <--- UPDATE YOUR REGION

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan (Drift Check)
        id: plan
        # This logic captures the code regardless of success or failure
        run: |
          # Run plan. If it fails or detects drift, don't stop the script yet (set +e)
          set +e
          terraform plan -detailed-exitcode -out=drift.tfplan
          
          # Capture the exit code immediately
          EXIT_CODE=$?
          
          echo "TERRAFORM EXIT CODE: $EXIT_CODE"
          
          # Write it to the GitHub Output
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          # If it was a real error (1), fail the job manually now
          if [ $EXIT_CODE -eq 1 ]; then
            echo "Terraform failed with a syntax or auth error."
            exit 1
          fi
 
      - name: Create Pull Request if Drift Detected
        if: steps.plan.outputs.exit_code == '2' # Only run if Drift (2)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Drift Detected (Exit Code 2). Initiating PR..."
          terraform show -no-color drift.tfplan > plan.txt
          
          BRANCH="drift-fix-$(date +%s)"
          
          git config user.name "Drift Bot"
          git config user.email "bot@github.com"
          
          # Ensure we are on a clean slate
          git checkout -b $BRANCH
          git commit --allow-empty -m "chore: drift detection placeholder"
          git push origin $BRANCH
          
          gh pr create \
            --title "[DRIFT] Infrastructure Drift Detected" \
            --body "Terraform detected changes. <br><br> <pre>$(cat plan.txt | head -c 60000)</pre>" \
            --base main \
            --head $BRANCH
 